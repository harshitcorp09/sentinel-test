# This policy uses the Sentinel tfplan/v2 import to require that
# all EC2 instances have instance types from an allowed list

import "tfplan/v2" as tfplan

# Allowed EC2 Instance Types
allowed_types = ["t2.small", "t2.medium", "t2.large"]

# Get all EC2 instances
allEC2Instances = [
  instance
  for instance in tfplan.resources
  if instance.type == "aws_instance"
]

# Filter to EC2 instances with violations
violatingEC2Instances = [
  instance
  for instance in allEC2Instances
  if !(instance.attributes.instance_type contains allowed_types)
]

# Count violations
violations = length(violatingEC2Instances)

# Main rule
main = rule {
  violations is 0
}
